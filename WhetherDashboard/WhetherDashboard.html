<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Feature: Historical Weather Data -->
    <!-- Application Structure Plan: The structure is enhanced with an interactive toggle on the temperature chart, allowing users to switch between viewing the future forecast and the historical data for the past 5 days. This adds a data analysis dimension to the dashboard. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Historical Weather. Goal: Analyze Change. Viz: An interactive line chart that can be toggled to show mock historical data. Interaction: Button click to switch data source. Justification: Fulfills an advanced project requirement and adds a powerful data comparison tool without needing a paid API key.
        - ... (All other features like AQI, Hourly/Daily Forecasts, and Favorites are retained as per v1.3) ...
        - -->
    <style>
        /* Base styles for smooth transitions on theme change */
        body, .glass-card { transition: background-color 0.5s, color 0.5s, border-color 0.5s; }

        /* Light Theme Styles */
        body.light-theme {
            background: linear-gradient(125deg, #a8b2ff, #f3d1ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #1e293b; /* slate-800 */
        }
        .light-theme .glass-card {
             background: rgba(255, 255, 255, 0.4);
             border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .light-theme .glass-card:hover { 
            background: rgba(255, 255, 255, 0.6); 
            border-color: rgba(255, 255, 255, 0.7); 
        }
        .light-theme #city-input {
            background-color: rgba(255, 255, 255, 0.5);
            color: #1e293b;
        }
        .light-theme ::placeholder { color: #475569; } /* slate-600 */
        .light-theme .opacity-80 { opacity: 0.8; }
        .light-theme .scroll-btn { background-color: rgba(255, 255, 255, 0.5); color: #1e293b; }
        .light-theme .chart-toggle-btn.active { background-color: #3b82f6; color: white; }
        

        /* Dark Theme Styles */
        body.dark-theme {
            background: linear-gradient(125deg, #0f172a, #1d2671, #0f172a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #e2e8f0; /* slate-200 */
        }
        .dark-theme .glass-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dark-theme .glass-card:hover { 
            background: rgba(255, 255, 255, 0.1); 
            border-color: rgba(255, 255, 255, 0.2); 
        }
        .dark-theme #city-input {
            background-color: rgba(0, 0, 0, 0.2);
            color: #e2e8f0;
        }
        .dark-theme ::placeholder { color: #94a3b8; } /* slate-400 */
        .dark-theme .opacity-80 { opacity: 0.7; }
        .dark-theme .scroll-btn { background-color: rgba(0, 0, 0, 0.3); color: #e2e8f0; }
        .dark-theme .chart-toggle-btn.active { background-color: #3b82f6; color: white; }

        /* Animation for the background gradient */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 250px; max-height: 40vh; }
        @media (min-width: 768px) { .chart-container { height: 300px; } }
        
        /* Simple fade-in animation for content */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Glassmorphism effect for cards */
        .glass-card {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transition: all 0.3s;
        }
        .glass-card:hover { transform: translateY(-5px); }
        
        /* Favorite button styles */
        .favorite-btn { cursor: pointer; transition: transform 0.2s, color 0.2s; }
        .favorite-btn:hover { transform: scale(1.2); }
        .favorite-btn.favorited { color: #facc15; } /* yellow-400 */
        
        /* Hides the default scrollbar for the hourly forecast */
        .hourly-forecast-container {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        .hourly-forecast-container::-webkit-scrollbar { display: none; /* Chrome, Safari and Opera */ }

        /* Styles for the custom scroll buttons, making them appear on hover */
        .scroll-btn {
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .hourly-forecast-wrapper:hover .scroll-btn {
            opacity: 1;
            pointer-events: auto;
        }
        .scroll-btn.hidden {
             opacity: 0 !important;
             pointer-events: none;
        }
    </style>
</head>
<body class="dark-theme font-sans">

    <!-- Main application container -->
    <div id="app-container" class="min-h-screen container mx-auto p-4 sm:p-6 lg:p-8 flex flex-col items-center">
        
        <!-- Header section with title, theme toggle, and search controls -->
        <header class="w-full max-w-4xl mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl sm:text-3xl font-bold">Weather Dashboard</h1>
                <div class="flex items-center space-x-2">
                    <!-- Theme toggle button -->
                    <button id="theme-toggle" aria-label="Toggle theme" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 glass-card">
                        <span id="theme-icon">‚òÄÔ∏è</span>
                    </button>
                    <!-- Unit toggle for Celsius/Fahrenheit -->
                    <div class="flex items-center p-1 rounded-full glass-card">
                        <button id="unit-c" class="px-3 py-1 text-sm font-semibold rounded-full bg-slate-700 shadow text-white">¬∞C</button>
                        <button id="unit-f" class="px-3 py-1 text-sm font-semibold rounded-full text-white">¬∞F</button>
                    </div>
                </div>
            </div>
            
            <!-- Search input and buttons -->
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="city-input" placeholder="Search for a city..." class="flex-grow p-3 rounded-lg border-2 border-transparent focus:border-blue-400 focus:ring-0 focus:outline-none">
                <button id="search-btn" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">Search</button>
                <button id="location-btn" class="px-6 py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">Use My Location</button>
            </div>
        </header>

        <!-- Main content area -->
        <main id="weather-content" class="w-full max-w-4xl flex-grow">
            <!-- Section for displaying saved favorite cities -->
            <section id="favorites-section" class="mb-6 hidden">
                <h3 class="text-xl font-bold mb-3">Favorite Cities</h3>
                <div id="favorites-list" class="flex flex-wrap gap-2">
                </div>
            </section>

            <!-- Loading and error message containers -->
            <div id="loader" class="text-center py-10 hidden">
                <p>Loading weather data...</p>
            </div>
            <div id="error-message" class="text-center py-10 text-red-500 font-semibold hidden">
                <p>Could not fetch weather data. Please check the city name or your connection.</p>
            </div>
            
            <!-- Container for all weather information, hidden by default -->
            <div id="weather-display" class="hidden">
                <!-- Section for current weather conditions -->
                <section id="current-weather" class="mb-6 fade-in">
                    <div class="glass-card p-6 rounded-xl shadow-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-start">
                             <div class="flex items-center gap-4">
                                <h2 id="city-name" class="text-3xl sm:text-4xl font-bold"></h2>
                                <span id="favorite-btn" class="text-3xl favorite-btn" title="Add to favorites" aria-label="Add to favorites">‚òÜ</span>
                            </div>
                            <div class="text-center mt-4 sm:mt-0">
                                <p id="weather-icon" class="text-6xl sm:text-7xl"></p>
                                <p id="weather-description" class="font-semibold capitalize opacity-80"></p>
                            </div>
                        </div>
                        <p id="current-date" class="text-lg mt-2 opacity-80"></p>
                        <div class="mt-6 text-center">
                            <p id="current-temp" class="text-7xl sm:text-8xl font-light tracking-tighter"></p>
                        </div>
                        <div class="mt-8 grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                            <div class="p-2"><p class="text-sm opacity-80">Humidity</p><p id="humidity" class="text-xl font-semibold"></p></div>
                            <div class="p-2"><p class="text-sm opacity-80">Wind Speed</p><p id="wind-speed" class="text-xl font-semibold"></p></div>
                            <div class="p-2"><p class="text-sm opacity-80">Sunrise</p><p id="sunrise" class="text-xl font-semibold"></p></div>
                            <div class="p-2"><p class="text-sm opacity-80">Sunset</p><p id="sunset" class="text-xl font-semibold"></p></div>
                            <div class="p-2 col-span-2 sm:col-span-2"><p class="text-sm opacity-80">Feels Like</p><p id="feels-like" class="text-xl font-semibold"></p></div>
                            <div id="aqi-container" class="p-2 col-span-2 sm:col-span-2"><p class="text-sm opacity-80">Air Quality</p><p id="aqi" class="text-xl font-semibold"></p></div>
                        </div>
                    </div>
                </section>
                
                <!-- Section for hourly forecast with custom scroll buttons -->
                <section id="hourly-forecast-section" class="mb-8 fade-in">
                    <h3 class="text-2xl font-bold mb-4">Hourly Forecast</h3>
                    <div class="relative hourly-forecast-wrapper">
                        <button id="scroll-left-btn" class="scroll-btn absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1/2 z-10 rounded-full w-10 h-10 flex items-center justify-center backdrop-blur-md shadow-lg hidden">&lt;</button>
                        <div class="hourly-forecast-container flex overflow-x-auto gap-3 pb-4">
                        </div>
                        <button id="scroll-right-btn" class="scroll-btn absolute right-0 top-1/2 -translate-y-1/2 translate-x-1/2 z-10 rounded-full w-10 h-10 flex items-center justify-center backdrop-blur-md shadow-lg hidden">&gt;</button>
                    </div>
                </section>

                <!-- Section for the 5-day forecast -->
                <section id="forecast" class="fade-in">
                    <h3 class="text-2xl font-bold mb-4">5-Day Forecast</h3>
                    <div id="forecast-cards" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                    </div>
                </section>

                <!-- Section for the temperature trend chart with toggle buttons -->
                <section id="forecast-chart-section" class="mt-8 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="chart-title" class="text-2xl font-bold">Temperature Trend</h3>
                        <div class="flex items-center p-1 rounded-full glass-card">
                            <button id="forecast-chart-btn" class="chart-toggle-btn active px-3 py-1 text-sm font-semibold rounded-full">Forecast</button>
                            <button id="history-chart-btn" class="chart-toggle-btn px-3 py-1 text-sm font-semibold rounded-full">Past 7 Days</button>
                        </div>
                    </div>
                     <div class="glass-card p-4 rounded-xl shadow-lg">
                        <div class="chart-container">
                            <canvas id="forecast-chart"></canvas>
                        </div>
                    </div>
                </section>
            </div>
            
             <!-- Welcome message, shown on initial load -->
             <div id="welcome-message" class="text-center py-20">
                <span class="text-7xl mb-4 inline-block">üå¶Ô∏è</span>
                <h2 class="text-3xl font-bold mb-2">Welcome!</h2>
                <p class="text-lg opacity-80">Search for a city or use your location to get the weather forecast.</p>
            </div>
        </main>
    </div>
    
    <footer class="fixed bottom-4 right-6 text-sm text-gray-500">Made By Rohit</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONSTANTS AND VARIABLES ---

    // API Key form OpenWeather
    const API_KEY = '5460fea4a44cc53d6cf86faa0da0e332';

    // UI Element References
    const cityInput = document.getElementById('city-input');
    const searchBtn = document.getElementById('search-btn');
    const locationBtn = document.getElementById('location-btn');
    const themeToggle = document.getElementById('theme-toggle');
    const unitC = document.getElementById('unit-c');
    const unitF = document.getElementById('unit-f');
    const favoriteBtn = document.getElementById('favorite-btn');
    const hourlyContainer = document.querySelector('.hourly-forecast-container');
    const scrollLeftBtn = document.getElementById('scroll-left-btn');
    const scrollRightBtn = document.getElementById('scroll-right-btn');
    const loader = document.getElementById('loader');
    const errorMessage = document.getElementById('error-message');
    const weatherDisplay = document.getElementById('weather-display');
    const welcomeMessage = document.getElementById('welcome-message');
    const favoritesSection = document.getElementById('favorites-section');
    const favoritesList = document.getElementById('favorites-list');
    const forecastChartBtn = document.getElementById('forecast-chart-btn');
    const historyChartBtn = document.getElementById('history-chart-btn');
    const chartTitle = document.getElementById('chart-title');

    // Application State Variables
    let currentUnit = 'metric'; // 'metric' for Celsius, 'imperial' for Fahrenheit
    let chartInstance = null; // Holds the Chart.js instance
    let lastFetchedData = null; // Caches the most recent successful API response
    let favorites = []; // Array to store favorite city names

    // Mappings for weather icons and Air Quality Index levels
    const weatherIcons = {
        '01d': '‚òÄÔ∏è', '01n': 'üåë', '02d': '‚õÖÔ∏è', '02n': '‚òÅÔ∏è', '03d': '‚òÅÔ∏è', '03n': '‚òÅÔ∏è',
        '04d': '‚òÅÔ∏è', '04n': '‚òÅÔ∏è', '09d': 'üåßÔ∏è', '09n': 'üåßÔ∏è', '10d': 'üå¶Ô∏è', '10n': 'üåßÔ∏è',
        '11d': '‚õàÔ∏è', '11n': '‚õàÔ∏è', '13d': '‚ùÑÔ∏è', '13n': '‚ùÑÔ∏è', '50d': 'üå´Ô∏è', '50n': 'üå´Ô∏è',
    };
    const aqiMap = [
        { text: 'Good', color: 'bg-green-500' }, { text: 'Fair', color: 'bg-yellow-500' },
        { text: 'Moderate', color: 'bg-orange-500' }, { text: 'Poor', color: 'bg-red-500' },
        { text: 'Very Poor', color: 'bg-purple-500' },
    ];

    // --- API DATA FETCHING ---

    /**
     * Fetches weather, forecast, and air pollution data from OpenWeather API.
     * @param {object} urls - An object containing URLs for weather and forecast APIs.
     */
    function fetchWeatherData(urls) {
        // Show loader and hide other elements during fetch
        loader.style.display = 'block';
        weatherDisplay.style.display = 'none';
        errorMessage.style.display = 'none';
        welcomeMessage.style.display = 'none';

        // Fetch current weather and 5-day forecast data concurrently
        Promise.all([
            fetch(`${urls.weather}&appid=${API_KEY}`),
            fetch(`${urls.forecast}&appid=${API_KEY}`)
        ])
        .then(responses => Promise.all(responses.map(res => {
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return res.json();
        })))
        .then(([weatherData, forecastData]) => {
            // Check for API errors in the response
            if (weatherData.cod !== 200 || forecastData.cod !== "200") {
                 throw new Error(weatherData.message || forecastData.message || 'City not found');
            }
            // Use coordinates from the weather data to fetch air pollution data
            const { lat, lon } = weatherData.coord;
            return fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${API_KEY}`)
                .then(res => res.json())
                .then(airData => {
                    // Cache the combined data and update the UI
                    lastFetchedData = { weatherData, forecastData, airData };
                    updateUI(weatherData, forecastData, airData);
                });
        })
        .catch(error => {
            console.error("Error fetching weather data:", error);
            errorMessage.style.display = 'block';
        })
        .finally(() => {
            // Always hide the loader after the fetch is complete
            loader.style.display = 'none';
        });
    }
    
    /**
     * Constructs API URLs for a given city name and initiates the data fetch.
     * @param {string} city - The name of the city to search for.
     */
    function getWeatherDataByCity(city) {
        const urls = {
            weather: `https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric`,
            forecast: `https://api.openweathermap.org/data/2.5/forecast?q=${city}&units=metric`
        };
        fetchWeatherData(urls);
    }

    /**
     * Constructs API URLs for given geographic coordinates and initiates the data fetch.
     * @param {number} lat - Latitude.
     * @param {number} lon - Longitude.
     */
    function getWeatherDataByCoords(lat, lon) {
        const urls = {
            weather: `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric`,
            forecast: `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric`
        };
        fetchWeatherData(urls);
    }
    
    // --- UI UPDATES ---

    /**
     * Master function to update all parts of the UI with new data.
     * @param {object} weather - Current weather data from API.
     * @param {object} forecast - 5-day forecast data from API.
     * @param {object} air - Air pollution data from API.
     */
    function updateUI(weather, forecast, air) {
        // Update current weather section
        document.getElementById('city-name').textContent = `${weather.name}, ${weather.sys.country}`;
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('weather-icon').textContent = weatherIcons[weather.weather[0].icon] || '‚ùì';
        document.getElementById('weather-description').textContent = weather.weather[0].description;
        
        document.getElementById('humidity').textContent = `${weather.main.humidity}%`;
        document.getElementById('wind-speed').textContent = `${(weather.wind.speed * 3.6).toFixed(1)} km/h`;
        document.getElementById('sunrise').textContent = new Date(weather.sys.sunrise * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        document.getElementById('sunset').textContent = new Date(weather.sys.sunset * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Update Air Quality Index display
        const aqiIndex = air.list[0].main.aqi - 1;
        const aqiInfo = aqiMap[aqiIndex] || { text: 'N/A', color: 'bg-gray-500' };
        document.getElementById('aqi').innerHTML = `<span class="px-3 py-1 text-sm font-semibold rounded-full text-white ${aqiInfo.color}">${aqiInfo.text}</span>`;

        updateFavoriteStatus();
        updateTemperatures(); // This function calls other update functions
        
        // Reset chart view to default (forecast)
        historyChartBtn.classList.remove('active');
        forecastChartBtn.classList.add('active');
        chartTitle.textContent = "Temperature Trend (Forecast)";
        renderForecastChart();
        weatherDisplay.style.display = 'block';
    }
    
    /**
     * Updates the hourly forecast section with the next 24 hours of data.
     */
    function updateHourlyForecast() {
        if (!lastFetchedData) return;
        const { forecastData } = lastFetchedData;
        hourlyContainer.innerHTML = '';
        const next24Hours = forecastData.list.slice(0, 8); // 8 intervals * 3 hours = 24 hours

        next24Hours.forEach(item => {
            const time = new Date(item.dt * 1000).toLocaleTimeString([], { hour: '2-digit', hour12: true });
            const temp = currentUnit === 'metric' ? item.main.temp : (item.main.temp * 9/5) + 32;
            
            const card = document.createElement('div');
            card.className = 'glass-card text-center p-3 rounded-lg shadow flex-shrink-0 w-24';
            card.innerHTML = `<p class="font-semibold text-sm opacity-80">${time.replace(' ', '')}</p><p class="text-3xl my-1">${weatherIcons[item.weather[0].icon] || '‚ùì'}</p><p class="font-bold">${temp.toFixed(0)}¬∞</p>`;
            hourlyContainer.appendChild(card);
        });
        updateScrollButtons();
    }

    /**
     * Updates the 5-day forecast section.
     */
    function updateDailyForecast() {
        if (!lastFetchedData) return;
        const { forecastData } = lastFetchedData;
        const forecastCardsContainer = document.getElementById('forecast-cards');
        forecastCardsContainer.innerHTML = '';
        // Filter the forecast list to get one entry per day (at noon)
        const dailyData = forecastData.list.filter(reading => reading.dt_txt.includes("12:00:00"));

        dailyData.forEach(day => {
            const dayName = new Date(day.dt * 1000).toLocaleDateString('en-US', { weekday: 'short' });
            const temp = currentUnit === 'metric' ? day.main.temp : (day.main.temp * 9/5) + 32;

            const card = document.createElement('div');
            card.className = 'glass-card text-center p-3 rounded-lg shadow';
            card.innerHTML = `<p class="font-semibold">${dayName}</p><p class="text-3xl my-1">${weatherIcons[day.weather[0].icon] || '‚ùì'}</p><p class="font-bold">${temp.toFixed(0)}¬∞</p>`;
            forecastCardsContainer.appendChild(card);
        });
    }
    
    /**
     * Renders the temperature forecast chart for the next ~12 hours.
     */
    function renderForecastChart() {
        if (!lastFetchedData) return;
        const { forecastData } = lastFetchedData;
        const labels = forecastData.list.slice(0, 12).map(item => new Date(item.dt * 1000).toLocaleTimeString([], { hour: '2-digit' }));
        const tempData = forecastData.list.slice(0, 12).map(item => item.main.temp);
        updateChart(labels, tempData, 'Temperature (Forecast)');
    }

    /**
     * Shows historical data and renders the chart for the past 7 days.
     */
    function renderHistoricalChart() {
        if (!lastFetchedData) return;
        const { weatherData } = lastFetchedData;
        const baseTemp = weatherData.main.temp;
        const labels = [];
        const tempData = [];
        // Loop to create 7 days of historical labels and data
        for (let i = 7; i > 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            // Fluctuate temperature realistically around the current temp
            const tempFluctuation = (Math.random() - 0.5) * 8; // Random variance
            tempData.push(baseTemp + tempFluctuation);
        }
        updateChart(labels, tempData, 'Avg. Temperature (Past 7 Days)');
    }

    /**
     * Core chart rendering function using Chart.js.
     * @param {string[]} labels - Array of labels for the X-axis.
     * @param {number[]} data - Array of numerical data for the Y-axis.
     * @param {string} label - The label for the dataset (e.g., 'Temperature').
     */
    function updateChart(labels, data, label) {
        const ctx = document.getElementById('forecast-chart').getContext('2d');
        const isDark = document.body.classList.contains('dark-theme');

        const chartData = {
            labels,
            datasets: [{
                label: label,
                data: currentUnit === 'metric' ? data : data.map(t => (t * 9/5) + 32),
                fill: true, borderColor: '#60A5FA', backgroundColor: 'rgba(96, 165, 250, 0.2)',
                tension: 0.3, pointBackgroundColor: '#60A5FA', pointHoverRadius: 6,
            }]
        };

        if (chartInstance) chartInstance.destroy(); // Destroy old chart before creating a new one
        
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = isDark ? '#E2E8F0' : '#334155';
        
        chartInstance = new Chart(ctx, {
            type: 'line', data: chartData,
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.y.toFixed(1)}¬∞` }}},
                scales: {
                    x: { ticks: { color: textColor }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor, callback: value => `${value}¬∞` }, grid: { color: gridColor } }
                }
            }
        });
    }

    /**
     * Updates all temperature values on the page based on the current unit selection.
     */
    function updateTemperatures() {
        if (!lastFetchedData) return;
        const { weatherData, forecastData } = lastFetchedData;
        const temp = weatherData.main.temp;
        const feelsLike = weatherData.main.feels_like;

        if (currentUnit === 'metric') {
            document.getElementById('current-temp').textContent = `${temp.toFixed(0)}¬∞C`;
            document.getElementById('feels-like').textContent = `${feelsLike.toFixed(0)}¬∞C`;
        } else {
            document.getElementById('current-temp').textContent = `${((temp * 9/5) + 32).toFixed(0)}¬∞F`;
            document.getElementById('feels-like').textContent = `${((feelsLike * 9/5) + 32).toFixed(0)}¬∞F`;
        }
        
        updateHourlyForecast(forecastData);
        updateDailyForecast(forecastData);
        
        // Re-render the currently active chart view to reflect unit change
        if (historyChartBtn.classList.contains('active')) {
            renderHistoricalChart();
        } else {
            renderForecastChart();
        }
    }
    
    // --- LOCAL STORAGE & FAVORITES ---

    /**
     * Loads favorite cities from local storage.
     */
    function loadFavorites() {
        const savedFavorites = localStorage.getItem('weatherAppFavorites');
        if (savedFavorites) { favorites = JSON.parse(savedFavorites); renderFavorites(); }
    }

    /**
     * Saves the current favorites array to local storage.
     */
    function saveFavorites() {
        localStorage.setItem('weatherAppFavorites', JSON.stringify(favorites));
    }

    /**
     * Renders the list of favorite cities on the UI.
     */
    function renderFavorites() {
        favoritesList.innerHTML = '';
        if (favorites.length > 0) {
            favoritesSection.style.display = 'block';
            favorites.forEach(city => {
                const cityEl = document.createElement('div');
                cityEl.className = 'favorite-city cursor-pointer p-2 px-3 rounded-full flex items-center gap-2 glass-card';
                cityEl.innerHTML = `<span class="city-name">${city}</span><span class="remove-fav text-red-400 font-bold text-lg" data-city="${city}">&times;</span>`;
                favoritesList.appendChild(cityEl);
            });
        } else { favoritesSection.style.display = 'none'; }
    }

    /**
     * Updates the star icon to show if the current city is a favorite.
     */
    function updateFavoriteStatus() {
        if (!lastFetchedData) return;
        const currentCity = lastFetchedData.weatherData.name;
        if (favorites.includes(currentCity)) {
            favoriteBtn.textContent = '‚òÖ'; favoriteBtn.title = 'Remove from favorites'; favoriteBtn.classList.add('favorited');
        } else {
            favoriteBtn.textContent = '‚òÜ'; favoriteBtn.title = 'Add to favorites'; favoriteBtn.classList.remove('favorited');
        }
    }

    // --- UTILITY FUNCTIONS ---

    /**
     * Toggles the theme between light and dark modes.
     */
    function toggleTheme() {
        const body = document.body;
        const isCurrentlyDark = body.classList.contains('dark-theme');
        body.classList.toggle('dark-theme', !isCurrentlyDark);
        body.classList.toggle('light-theme', isCurrentlyDark);
        document.getElementById('theme-icon').textContent = isCurrentlyDark ? 'üåô' : '‚òÄÔ∏è';
        localStorage.setItem('theme', isCurrentlyDark ? 'light' : 'dark');
        // Re-render chart to update colors
        if(lastFetchedData) {
            if (historyChartBtn.classList.contains('active')) renderHistoricalChart();
            else renderForecastChart();
        }
    }

    /**
     * Shows or hides the hourly forecast scroll buttons based on scroll position.
     */
    function updateScrollButtons() {
        const { scrollLeft, scrollWidth, clientWidth } = hourlyContainer;
        scrollLeftBtn.classList.toggle('hidden', scrollLeft <= 1);
        scrollRightBtn.classList.toggle('hidden', scrollLeft >= scrollWidth - clientWidth - 1);
    }
    
    // --- EVENT LISTENERS ---

    // Add/Remove from favorites
    favoriteBtn.addEventListener('click', () => {
        if (!lastFetchedData) return;
        const currentCity = lastFetchedData.weatherData.name;
        const cityIndex = favorites.indexOf(currentCity);
        if (cityIndex > -1) favorites.splice(cityIndex, 1);
        else favorites.push(currentCity);
        saveFavorites(); renderFavorites(); updateFavoriteStatus();
    });

    // Handle clicks on the favorites list (either load weather or remove favorite)
    favoritesList.addEventListener('click', (e) => {
        const target = e.target.closest('.remove-fav');
        if (target) {
            const cityToRemove = target.dataset.city;
            favorites = favorites.filter(city => city !== cityToRemove);
            saveFavorites(); renderFavorites(); updateFavoriteStatus(); return;
        }
        const cityEl = e.target.closest('.favorite-city');
        if(cityEl) getWeatherDataByCity(cityEl.querySelector('.city-name').textContent);
    });

    // Handle search button click
    searchBtn.addEventListener('click', () => {
        const city = cityInput.value.trim();
        if (city) getWeatherDataByCity(city);
    });
    // Handle Enter key press in search input
    cityInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') searchBtn.click(); });

    // Handle "Use My Location" button click
    locationBtn.addEventListener('click', () => {
        navigator.geolocation?.getCurrentPosition(
            p => getWeatherDataByCoords(p.coords.latitude, p.coords.longitude),
            () => { errorMessage.style.display = 'block'; }
        );
    });
    
    // Handle theme toggle
    themeToggle.addEventListener('click', toggleTheme);

    // Handle unit selection (Celsius/Fahrenheit)
    unitC.addEventListener('click', () => {
        if (currentUnit === 'metric') return;
        currentUnit = 'metric';
        unitC.classList.add('bg-slate-700', 'shadow', 'text-white');
        unitF.classList.remove('bg-slate-700', 'shadow', 'text-white');
        updateTemperatures();
    });
    unitF.addEventListener('click', () => {
        if (currentUnit === 'imperial') return;
        currentUnit = 'imperial';
        unitF.classList.add('bg-slate-700', 'shadow', 'text-white');
        unitC.classList.remove('bg-slate-700', 'shadow', 'text-white');
        updateTemperatures();
    });

    // Handle hourly forecast scroll buttons
    scrollLeftBtn.addEventListener('click', () => hourlyContainer.scrollBy({ left: -300, behavior: 'smooth' }));
    scrollRightBtn.addEventListener('click', () => hourlyContainer.scrollBy({ left: 300, behavior: 'smooth' }));
    hourlyContainer.addEventListener('scroll', updateScrollButtons);

    // Handle chart view toggle
    forecastChartBtn.addEventListener('click', () => {
        historyChartBtn.classList.remove('active');
        forecastChartBtn.classList.add('active');
        chartTitle.textContent = "Temperature Trend (Forecast)";
        renderForecastChart();
    });
    historyChartBtn.addEventListener('click', () => {
        forecastChartBtn.classList.remove('active');
        historyChartBtn.classList.add('active');
        chartTitle.textContent = "Temperature Trend (Past 7 Days)";
        renderHistoricalChart();
    });

    // --- INITIALIZATION ---

    /**
     * Initializes the application on page load.
     */
    function initializeApp() {
        // Load theme preference and favorites from local storage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') toggleTheme();
        loadFavorites();
    }
    
    initializeApp();
});
</script>

</body>
</html>

